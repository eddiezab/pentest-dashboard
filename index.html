<!DOCTYPE html>
<html>
	<head>
		<title>Dashboard</title>
		<script type="text/javascript" src="scripts/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="scripts/jquery-ui.js"></script>
		<link rel="stylesheet" href="styles/jquery-ui.css" />
		<style type="text/css">
			html,body {			
				background: rgb(0,0,0);
				margin: 0px;
				padding: 1;			
				height: 100%;
				width: 100%;
				color: #fff;
			}			
			
			#container, #error-overlay {
				position: absolute;
				top: 0px;
				left: 0px;
				height: 100%;
				width: 100%;
			}
			
			#sidebar {
				left: 0px;
				width: 249px;
				height: 100%;
				overflow: none;
				float: left;
			}	
			
			#sidebar div {
				height: 50%;
			}
			
			#screenshot-container {
				left: 250px;
				width: auto;
				overflow: hidden;
				height: 100%;
			}
			
			#screenshot-container img {
				height: auto;
				width: 100%;
			}
			
			#pause {
				position: fixed;
				bottom: 0px;		
				right: 0px;
				color: black;							
				clear:both;
				width: 150px;
				text-align: center;
				margin: .5em;
				background: rgba(192, 192, 192, 1);
			}
			
			#error-overlay {
				background: rgba(0,0,0,0.8);
			}
			
			#error-overlay div {
				position: fixed;
				top: 50%;
				left: 50%;
				margin-left: -125px;
				margin-top: .5em;
				width: 250px;
				height: 1em;
				text-align: center;
			}

			.border {
				padding: .75em;
				border: 2px solid gray;
				border-radius: 5px;
			}
			
			table {
				width: 100%;
				border-spacing: 0px;
				border-collapse: collapse;
			}

			th {
				background: #aaa;
				color: #000;
			}

			tr.even	{
				background: #333;
			}

			tr.odd {
				background: #555;
			}
			
			.offline {
				color: red;
			}

			.online {
				color: green;
			}
			
		</style>
	</head>
	<body>
	
	<div id="container">
		<div id="sidebar">
			<div id="scoreboard">
				<table id="scores">
					<tr>
						<th>Handle</th>
						<th>Current Score</th>
					</tr>
				</table>
			</div>
			<div id="stats">
				<table>
					<tr>
						<th colspan="2">Cortana Data</th>
					</tr>
					<tr class="even">
						<td>Active Sessions</td><td class="right" id="active_sessions"></td>
					</tr>
					<tr class="odd">
						<td>Hosts Scanned</td><td class="right" id="host_count"></td>
					</tr>
				</table>
			</div>
		</div>
		<div id="screenshot-container">
			<img id="active-screenshot" src="init.jpg" alt="Splash" />
		</div>
		<div id="pause" class="border">Paused.</div>
	</div>
	<div id="error-overlay">
		<div class="border">There is an error contacting the server.</div>
	</div>
	<script type="text/javascript">
		var isErroring = false;
		var isPaused = false;
	
		var imageCache = new Array();
		var imageIndex = -1;
		
		var refreshSpeed = 10000;
	
		function updateStats(data) {
			$("#active_sessions").text(data.session_count);
			$("#host_count").text(data.host_count);
		}
	
		function updateDashboard (data) {
			if (isErroring) {
				$("error-overlay").fadeOut(1000);
				return;
			}
			
			setScreenshot(data.screenshot);
			imageCache.push(data.screenshot);
			
			updateHacker(data.hackers, data["cortana-data"]);
			updateStats(data["cortana-data"]);
		}
		
		function updateHacker(data, cortana_data) {
			$("#scores").empty();
			$("#scores").append("<tr><th>Handle</th><th>Current Score</th></tr>");
			
			var count = 0;
			
			for (var key in data)
			{	
				var row_class = "even";
				
				if (count % 2 != 0)
					row_class = "odd";
				
				if (cortana_data.online_users.indexOf(key) != -1)
					row_class += " online"; 
				else
					row_class += " offline";
				
				$("#scores").append("<tr class=\"" + row_class + "\"><td>" + key + "</td><td class=\"right\">" + data[key] + "</td></tr>");
				count = count + 1;
			}
		}
	
		function getData(timeOut) {
			setTimeout(function() {	
				if (!isPaused) {			
					$.getJSON("scoreboard.php",
						updateDashboard
					)
					.error(function() {
						if (!isErroring)
							$("#error-overlay").fadeIn(1000);
					});
				} else {
					console.log("Pausing updates. Press spacebar to continue.");
				};
				
				console.log(refreshSpeed);
				getData(refreshSpeed);
				
			},
			timeOut
			);
		}
	
		function pause() {
			isPaused = true;
			
			$("#pause").fadeIn(1000);
			$("#sidebar").hide("slide", { direction: "left" }, 1000);
			$("#screenshot").animate({left: "0"}, 1000);
		}
		
		function unpause() {
			isPaused = false;
			
			$("#pause").fadeOut(1000);
			$("#sidebar").show("slide", { direction: "left" }, 1000);
			$("#screenshot").animate({left: "250"}, 1000);		
			
			imageIndex = -1;
		}
	
		function pressEnter() {
		}
		
		function pressSpace() {					
			if (isPaused) {
				unpause();
			} else {
				pause();
			}
		}
		
		function pressLeft() {
			if (!isPaused)
				pause();
				
			if (imageIndex == 0)
				imageIndex = imageCache.length - 1;
			else {
				if (imageIndex == -1) 
					imageIndex = imageCache.length - 2;
				else
					imageIndex -= 1;
			}	
				
			setScreenshot(imageCache[imageIndex]);
		}
		
		function pressRight() {
			if (!isPaused)
				return;				

			if (imageIndex == imageCache.length - 1)
				imageIndex = 0;
			else
				imageIndex += 1;
			
			setScreenshot(imageCache[imageIndex]);
		}
		
		function pressUp() {
			if (refreshSpeed > 0) {
				refreshSpeed -= 1000;
				console.log("Refresh speed = "  + refreshSpeed);
			}
		}
		
		function pressDown() {
			refreshSpeed += 1000;
			console.log("Refresh speed = "  + refreshSpeed);
		}
		
		function setScreenshot(urlData) {
			$("#active-screenshot").attr("src", urlData).attr("alt", urlData);
		}
		
		$(document).ready(function() {			
			getData(0);
		
			setScreenshot("init.jpg");
			
			$("#error-overlay").fadeOut(0);
			$("#pause").fadeOut(0);
				

			$(document).keydown(function(e) {
				var isConsumed = false;
					
				switch(e.keyCode) {
					case 13:	// enter
						if (!isErroring) pressEnter();
						isConsumed = true;
						break;
					case 32:	// spacebar						
						if (!isErroring) pressSpace();
						isConsumed = true;
						break;
					case 37:	// left arrow
						if (!isErroring) pressLeft();
						isConsumed = true;
						break;
					case 38: 	// up arrow
						if (!isErroring) pressUp();
						isConsumed = true;
						break;
					case 39:	// right arrow
						if (!isErroring) pressRight();
						isConsumed = true;
						break;
					case 40:	// down arrow
						if (!isErroring) pressDown();
						isConsumed = true;
						break;
					default:
						console.log(e.keyCode);
						break;
				}
				
				if (isConsumed) {
					e.preventDefault();
					return false;
				}				
				return true;				
			});
		});
	</script>
	</body>
</html>
